<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Playboy - Tempo Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0b0b0b; color: white; }
        .visitor-tab { 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); 
            transition: all 0.3s ease;
        }
        .visitor-tab.active { 
            background: rgba(229,9,20,0.2); 
            border-color: #e50914; 
        }
        .visitor-tab:hover { 
            background: rgba(255,255,255,0.1); 
        }
        .event-item { 
            border-left: 3px solid #e50914; 
            padding-left: 12px; 
            margin-bottom: 8px; 
        }
        .event-click { border-left-color: #10b981; }
        .event-pageview { border-left-color: #3b82f6; }
        .event-time { border-left-color: #f59e0b; }
        .online-indicator { 
            width: 8px; height: 8px; 
            background: #10b981; 
            border-radius: 50%; 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .device-badge { 
            background: #3b82f6; 
            color: white; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
        }
        .location-badge { 
            background: #10b981; 
            color: white; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
        }
        .package-badge { 
            background: #e50914; 
            color: white; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-size: 12px; 
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-black/70 backdrop-blur border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm">P</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Monitor Playboy</h1>
                        <p class="text-sm text-gray-400">Monitoramento em Tempo Real</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <div id="connectionStatus" class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <span id="connectionText" class="text-sm text-green-400">Conectado</span>
                    </div>
                    <div class="text-xs text-gray-400">
                        <span id="visitorCount">0 visitantes</span>
                    </div>
                    <button onclick="refreshData()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md text-sm font-medium transition">
                        üîÑ Atualizar
                    </button>
                    <button onclick="clearData()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-md text-sm font-medium transition">
                        üóëÔ∏è Limpar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Layout Principal -->
    <div class="flex h-screen">
        <!-- Sidebar - Lista de Visitantes -->
        <div class="w-1/3 bg-gray-900/50 border-r border-white/10 overflow-y-auto">
            <div class="p-4">
                <h2 class="text-lg font-semibold mb-4">Visitantes Ativos</h2>
                <div id="visitorsList" class="space-y-2">
                    <!-- Visitantes ser√£o inseridos aqui -->
                </div>
            </div>
        </div>

        <!-- √Årea Principal - Detalhes do Visitante -->
        <div class="flex-1 flex flex-col">
            <!-- Abas de Visitantes -->
            <div id="visitorTabs" class="bg-gray-800/50 border-b border-white/10 p-4 overflow-x-auto">
                <!-- Abas ser√£o inseridas aqui -->
            </div>

            <!-- Conte√∫do da Aba Ativa -->
            <div id="visitorContent" class="flex-1 p-6 overflow-y-auto">
                <div class="text-center text-gray-400 py-12">
                    <div class="text-6xl mb-4">üëÅÔ∏è</div>
                    <h3 class="text-xl font-semibold mb-2">Selecione um Visitante</h3>
                    <p>Escolha um visitante na lista lateral para ver os detalhes</p>
                </div>
            </div>
        </div>
    </div>

    <!-- üéØ SISTEMA DE MONITORAMENTO CORRIGIDO -->
    <script>
        class PlayboyMonitor {
            constructor() {
                this.visitors = new Map();
                this.activeVisitor = null;
                this.visitorCounter = 1;
                
                this.init();
            }

            init() {
                this.loadInitialData();
                this.setupEventListeners();
                this.startRealTimeSync();
                
                console.log('üéØ Monitor Playboy iniciado');
            }

            loadInitialData() {
                try {
                    const data = localStorage.getItem('playboy_visitor_data');
                    if (data) {
                        const allData = JSON.parse(data);
                        this.processVisitorData(allData);
                        this.updateInterface();
                    }
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                }
            }

            processVisitorData(allData) {
                this.visitors.clear();
                
                // Carregar mapeamento persistente de visitantes
                const visitorMapping = this.loadVisitorMapping();
                
                // Agrupar dados por sessionId
                const sessions = {};
                allData.forEach(entry => {
                    if (!sessions[entry.sessionId]) {
                        // Verificar se j√° existe um n√∫mero para este visitante
                        let visitorNumber = visitorMapping[entry.sessionId];
                        if (!visitorNumber) {
                            visitorNumber = this.getNextVisitorNumber();
                            visitorMapping[entry.sessionId] = visitorNumber;
                            this.saveVisitorMapping(visitorMapping);
                        }
                        
                        sessions[entry.sessionId] = {
                            sessionId: entry.sessionId,
                            visitorNumber: visitorNumber,
                            firstSeen: entry.timestamp,
                            lastSeen: entry.timestamp,
                            totalVisits: 0,
                            totalClicks: 0,
                            device: null,
                            location: null,
                            events: [],
                            packageClicks: new Map()
                        };
                    }
                    
                    const visitor = sessions[entry.sessionId];
                    visitor.lastSeen = entry.timestamp;
                    visitor.events.push(entry);
                    
                    if (entry.type === 'page_view') {
                        visitor.totalVisits++;
                    } else if (entry.type === 'button_click') {
                        visitor.totalClicks++;
                        const packageName = entry.data.packageName || 'Desconhecido';
                        visitor.packageClicks.set(packageName, (visitor.packageClicks.get(packageName) || 0) + 1);
                    } else if (entry.type === 'device_info') {
                        visitor.device = entry.data.device || 'desktop';
                    }
                });
                
                // Converter para Map
                Object.values(sessions).forEach(visitor => {
                    this.visitors.set(visitor.sessionId, visitor);
                });
            }

            loadVisitorMapping() {
                try {
                    const mapping = localStorage.getItem('playboy_visitor_mapping');
                    return mapping ? JSON.parse(mapping) : {};
                } catch (error) {
                    console.error('Erro ao carregar mapeamento:', error);
                    return {};
                }
            }

            saveVisitorMapping(mapping) {
                try {
                    localStorage.setItem('playboy_visitor_mapping', JSON.stringify(mapping));
                } catch (error) {
                    console.error('Erro ao salvar mapeamento:', error);
                }
            }

            getNextVisitorNumber() {
                try {
                    const lastNumber = localStorage.getItem('playboy_last_visitor_number');
                    const nextNumber = lastNumber ? parseInt(lastNumber) + 1 : 1;
                    localStorage.setItem('playboy_last_visitor_number', nextNumber.toString());
                    return nextNumber;
                } catch (error) {
                    console.error('Erro ao gerar n√∫mero do visitante:', error);
                    return this.visitorCounter++;
                }
            }

            setupEventListeners() {
                // Escutar mudan√ßas no localStorage
                window.addEventListener('storage', (e) => {
                    if (e.key === 'playboy_visitor_data') {
                        this.loadInitialData();
                    }
                });
                
                // Escutar eventos customizados
                window.addEventListener('playboyDataUpdate', (e) => {
                    this.loadInitialData();
                });
            }

            startRealTimeSync() {
                // Verificar mudan√ßas a cada 2 segundos
                setInterval(() => {
                    this.loadInitialData();
                }, 2000);
            }

            updateInterface() {
                this.renderVisitorsList();
                this.renderVisitorTabs();
                this.updateVisitorCount();
                
                if (this.activeVisitor) {
                    this.renderVisitorDetails();
                }
            }

            renderVisitorsList() {
                const container = document.getElementById('visitorsList');
                const sortedVisitors = Array.from(this.visitors.values())
                    .sort((a, b) => new Date(b.lastSeen) - new Date(a.lastSeen));

                container.innerHTML = sortedVisitors.map(visitor => {
                    const isActive = this.activeVisitor === visitor.sessionId;
                    const isReturning = visitor.totalVisits > 1;
                    
                    return `
                        <div class="visitor-tab ${isActive ? 'active' : ''}" 
                             onclick="monitor.selectVisitor('${visitor.sessionId}')">
                            <div class="flex items-center justify-between p-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center">
                                        <span class="text-white font-bold text-sm">${visitor.visitorNumber}</span>
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-semibold">Visitante ${visitor.visitorNumber}</span>
                                            ${isReturning ? '<span class="text-xs bg-yellow-600 text-white px-2 py-1 rounded">Retornou</span>' : ''}
                                        </div>
                                        <div class="text-sm text-gray-400">
                                            ${visitor.device || 'Desktop'} ‚Ä¢ ${this.formatTime(visitor.lastSeen)}
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            ${visitor.totalVisits} visitas ‚Ä¢ ${visitor.totalClicks} cliques
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="online-indicator"></div>
                                    <span class="text-xs text-gray-400">Online</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderVisitorTabs() {
                const container = document.getElementById('visitorTabs');
                const sortedVisitors = Array.from(this.visitors.values())
                    .sort((a, b) => new Date(b.lastSeen) - new Date(a.lastSeen));

                container.innerHTML = sortedVisitors.map(visitor => {
                    const isActive = this.activeVisitor === visitor.sessionId;
                    
                    return `
                        <div class="inline-block mr-2">
                            <button class="px-4 py-2 rounded-lg text-sm font-medium transition ${isActive ? 'bg-red-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}"
                                    onclick="monitor.selectVisitor('${visitor.sessionId}')">
                                Visitante ${visitor.visitorNumber}
                                ${visitor.totalVisits > 1 ? ' üîÑ' : ''}
                            </button>
                        </div>
                    `;
                }).join('');
            }

            selectVisitor(sessionId) {
                this.activeVisitor = sessionId;
                this.renderVisitorsList();
                this.renderVisitorTabs();
                this.renderVisitorDetails();
            }

            renderVisitorDetails() {
                if (!this.activeVisitor) {
                    document.getElementById('visitorContent').innerHTML = `
                        <div class="text-center text-gray-400 py-12">
                            <div class="text-6xl mb-4">üëÅÔ∏è</div>
                            <h3 class="text-xl font-semibold mb-2">Selecione um Visitante</h3>
                            <p>Escolha um visitante na lista lateral para ver os detalhes</p>
                        </div>
                    `;
                    return;
                }

                const visitor = this.visitors.get(this.activeVisitor);
                if (!visitor) return;

                const events = visitor.events || [];
                const packageClicks = Array.from(visitor.packageClicks.entries());

                document.getElementById('visitorContent').innerHTML = `
                    <div class="space-y-6">
                        <!-- Informa√ß√µes do Visitante -->
                        <div class="bg-gray-800/50 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-semibold">Visitante ${visitor.visitorNumber}</h3>
                                <div class="flex items-center gap-2">
                                    <div class="online-indicator"></div>
                                    <span class="text-sm text-green-400">Online</span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <p class="text-sm text-gray-400">UUID</p>
                                    <p class="font-mono text-xs">${visitor.sessionId}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">Dispositivo</p>
                                    <span class="device-badge">${visitor.device || 'Desktop'}</span>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">Primeira Visita</p>
                                    <span class="text-sm">${this.formatTime(visitor.firstSeen)}</span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="text-center">
                                    <p class="text-2xl font-bold text-blue-400">${visitor.totalVisits}</p>
                                    <p class="text-sm text-gray-400">Visitas</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-2xl font-bold text-green-400">${visitor.totalClicks}</p>
                                    <p class="text-sm text-gray-400">Cliques</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-2xl font-bold text-purple-400">${packageClicks.length}</p>
                                    <p class="text-sm text-gray-400">Pacotes</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-2xl font-bold text-orange-400">${events.length}</p>
                                    <p class="text-sm text-gray-400">Eventos</p>
                                </div>
                            </div>
                        </div>

                        <!-- Cliques por Pacote -->
                        ${packageClicks.length > 0 ? `
                        <div class="bg-gray-800/50 rounded-lg p-6">
                            <h4 class="text-lg font-semibold mb-4">Cliques por Pacote</h4>
                            <div class="space-y-2">
                                ${packageClicks.map(([packageName, count]) => `
                                    <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
                                        <span class="package-badge">${packageName}</span>
                                        <span class="text-lg font-bold text-green-400">${count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <!-- Timeline de Eventos -->
                        <div class="bg-gray-800/50 rounded-lg p-6">
                            <h4 class="text-lg font-semibold mb-4">Timeline de Eventos</h4>
                            <div class="space-y-3 max-h-96 overflow-y-auto">
                                ${events.slice(-20).reverse().map(event => `
                                    <div class="event-item event-${event.type}">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <span class="font-semibold">${this.getEventLabel(event.type)}</span>
                                                ${event.data.packageName ? `<span class="package-badge ml-2">${event.data.packageName}</span>` : ''}
                                            </div>
                                            <span class="text-xs text-gray-400">${this.formatTime(event.timestamp)}</span>
                                        </div>
                                        ${event.data.title ? `<p class="text-sm text-gray-300 mt-1">${event.data.title}</p>` : ''}
                                        ${event.data.url ? `<p class="text-xs text-gray-500 mt-1">${event.data.url}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            updateVisitorCount() {
                const count = this.visitors.size;
                document.getElementById('visitorCount').textContent = `${count} visitante${count !== 1 ? 's' : ''}`;
            }

            getEventLabel(type) {
                const labels = {
                    'page_view': 'üìÑ P√°gina Visualizada',
                    'button_click': 'üõí Clique em Pacote',
                    'time_tracking': '‚è±Ô∏è Tempo na P√°gina',
                    'device_info': 'üì± Informa√ß√µes do Dispositivo'
                };
                return labels[type] || type;
            }

            formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return 'Agora';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}min atr√°s`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h atr√°s`;
                return date.toLocaleString('pt-BR');
            }
        }

        // Fun√ß√µes globais
        function refreshData() {
            if (window.monitor) {
                window.monitor.loadInitialData();
                console.log('üîÑ Dados atualizados!');
            }
        }

        function clearData() {
            if (confirm('Tem certeza que deseja limpar todos os dados?')) {
                localStorage.removeItem('playboy_visitor_data');
                localStorage.removeItem('playboy_visitor_mapping');
                localStorage.removeItem('playboy_last_visitor_number');
                localStorage.removeItem('playboy_visitor_id');
                location.reload();
            }
        }

        // Inicializar quando DOM estiver pronto
        document.addEventListener('DOMContentLoaded', () => {
            window.monitor = new PlayboyMonitor();
        });
    </script>
</body>
</html>
