<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Monitoramento - Playboy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #0b0b0b; color: white; }
        .card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        .stat-card { background: linear-gradient(135deg, #1a1a1a, #2a2a2a); }
        .online-indicator { 
            width: 8px; height: 8px; 
            background: #10b981; 
            border-radius: 50%; 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .visitor-card { 
            background: linear-gradient(135deg, #1e1e1e, #2d2d2d); 
            border-left: 4px solid #e50914; 
        }
        .click-highlight { background: rgba(229, 9, 20, 0.2); }
        .location-badge { background: #3b82f6; }
        .age-badge { background: #8b5cf6; }
        .device-badge { background: #10b981; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-black/70 backdrop-blur border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm">P</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Dashboard de Monitoramento</h1>
                        <p class="text-sm text-gray-400">Playboy - An√°lise de Visitantes</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <div class="online-indicator"></div>
                        <span class="text-sm text-green-400" id="systemStatus">Sistema Ativo</span>
                    </div>
                    <div class="text-xs text-gray-400" id="lastUpdate">
                        √öltima atualiza√ß√£o: <span id="updateTime">--:--</span>
                    </div>
                    <button onclick="refreshData()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md text-sm font-medium transition">
                        üîÑ Atualizar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Estat√≠sticas Principais -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total de Visitantes -->
            <div class="stat-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Total de Visitantes</p>
                        <p class="text-2xl font-bold text-white" id="totalVisitors">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">üë•</span>
                    </div>
                </div>
            </div>

            <!-- Cliques em Bot√µes -->
            <div class="stat-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Cliques em Bot√µes</p>
                        <p class="text-2xl font-bold text-white" id="totalClicks">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">üõí</span>
                    </div>
                </div>
            </div>

            <!-- Convers√£o -->
            <div class="stat-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Taxa de Convers√£o</p>
                        <p class="text-2xl font-bold text-white" id="conversionRate">0%</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">üìà</span>
                    </div>
                </div>
            </div>

            <!-- Tempo M√©dio -->
            <div class="stat-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Tempo M√©dio</p>
                        <p class="text-2xl font-bold text-white" id="avgTime">0s</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">‚è±Ô∏è</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Visitantes por Estado -->
        <div class="max-w-4xl mx-auto mb-8">
            <div class="card rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Visitantes por Estado</h3>
                <div id="locationList" class="space-y-3">
                    <!-- Lista ser√° preenchida dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Lista de Visitantes em Tempo Real -->
        <div class="card rounded-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold">Visitantes Ativos</h3>
                <div class="flex items-center gap-2">
                    <div class="online-indicator"></div>
                    <span class="text-sm text-green-400" id="activeVisitors">0 visitantes online</span>
                </div>
            </div>
            
            <div class="space-y-4" id="visitorsList">
                <!-- Visitantes ser√£o inseridos aqui dinamicamente -->
            </div>
        </div>

        <!-- An√°lise Detalhada -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
            <!-- Dispositivos -->
            <div class="card rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Dispositivos</h3>
                <div id="deviceStats" class="space-y-3">
                    <!-- Estat√≠sticas de dispositivos -->
                </div>
            </div>

            <!-- Faixa Et√°ria Estimada -->
            <div class="card rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Faixa Et√°ria</h3>
                <div id="ageStats" class="space-y-3">
                    <!-- Estat√≠sticas de idade -->
                </div>
            </div>

            <!-- Localiza√ß√£o -->
            <div class="card rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Localiza√ß√£o</h3>
                <div id="locationStats" class="space-y-3">
                    <!-- Estat√≠sticas de localiza√ß√£o -->
                </div>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script>
        let trackingData = [];
        let dashboardInitialized = false;

        // Inicializa o dashboard - VERS√ÉO TEMPO REAL
        function initDashboard() {
            console.log('üöÄ Inicializando dashboard em tempo real...');
            
            // Carrega dados iniciais
            loadTrackingData();
            updateStats();
            updateVisitorsList();
            updateLocationList();
            
            // Atualiza√ß√£o em tempo real a cada 5 segundos
            setInterval(() => {
                const hasChanges = loadTrackingData();
                updateStats();
                updateVisitorsList();
                updateLocationList();
                updateTimestamp();
                
                if (hasChanges) {
                    console.log('üîÑ Dashboard atualizado com novos dados!');
                    showUpdateNotification();
                } else {
                    console.log('üîÑ Dashboard atualizado em tempo real');
                }
            }, 5000);
        }

        // Carrega dados do sistema de tracking - VERS√ÉO TEMPO REAL
        function loadTrackingData() {
            let newData = [];
            
            // Tenta carregar dados do site Playboy
            if (typeof getPlayboyTrackingData === 'function') {
                newData = getPlayboyTrackingData();
                console.log('üìä Dados carregados do site Playboy:', newData.length, 'entradas');
            } else if (typeof getTrackingData === 'function') {
                newData = getTrackingData();
                console.log('üìä Dados carregados do sistema local:', newData.length, 'entradas');
            } else {
                // Dados de exemplo para demonstra√ß√£o
                newData = getSampleData();
                console.log('üìä Usando dados de exemplo:', newData.length, 'entradas');
            }
            
            // Detecta mudan√ßas nos dados
            if (newData.length !== trackingData.length) {
                console.log('üîÑ Novos dados detectados!', newData.length - trackingData.length, 'novas entradas');
                trackingData = newData;
                return true; // Indica que houve mudan√ßas
            }
            
            // Verifica se h√° dados novos por timestamp
            const latestTimestamp = Math.max(...newData.map(entry => new Date(entry.timestamp).getTime()));
            const currentLatestTimestamp = Math.max(...trackingData.map(entry => new Date(entry.timestamp).getTime()));
            
            if (latestTimestamp > currentLatestTimestamp) {
                console.log('üîÑ Dados atualizados detectados!');
                trackingData = newData;
                return true; // Indica que houve mudan√ßas
            }
            
            return false; // Nenhuma mudan√ßa detectada
        }

        // Dados de exemplo para demonstra√ß√£o - VERS√ÉO TEMPO REAL
        function getSampleData() {
            const now = Date.now();
            const cities = ['S√£o Paulo', 'Rio de Janeiro', 'Belo Horizonte', 'Salvador', 'Bras√≠lia', 'Fortaleza', 'Manaus', 'Curitiba'];
            const states = ['SP', 'RJ', 'MG', 'BA', 'DF', 'CE', 'AM', 'PR'];
            const packages = [
                { name: 'Pacote Premium', price: 'R$ 19,90' },
                { name: 'Pacote Sedu√ß√£o', price: 'R$ 10,00' }
            ];
            
            const data = [];
            
            // Gera dados simulados com timestamps recentes
            for (let i = 0; i < 5 + Math.floor(Math.random() * 10); i++) {
                const sessionId = 'playboy_' + (now - Math.random() * 3600000) + '_' + Math.random().toString(36).substr(2, 6);
                const cityIndex = Math.floor(Math.random() * cities.length);
                const packageIndex = Math.floor(Math.random() * packages.length);
                const timeOffset = Math.random() * 300000; // √öltimos 5 minutos
                
                // Dados de dispositivo
                data.push({
                    sessionId: sessionId,
                    timestamp: new Date(now - timeOffset).toISOString(),
                    type: 'device_info',
                    data: {
                        userAgent: Math.random() > 0.5 ? 'Mobile' : 'Desktop',
                        city: cities[cityIndex],
                        state: states[cityIndex]
                    }
                });
                
                // Dados de clique (70% de chance)
                if (Math.random() > 0.3) {
                    data.push({
                        sessionId: sessionId,
                        timestamp: new Date(now - timeOffset + 10000).toISOString(),
                        type: 'button_click',
                        data: {
                            packageName: packages[packageIndex].name,
                            price: packages[packageIndex].price
                        }
                    });
                }
            }
            
            return data;
        }

        // Atualiza estat√≠sticas - VERS√ÉO TEMPO REAL
        function updateStats() {
            const visitors = getUniqueVisitors();
            const clicks = getButtonClicks();
            const conversionRate = calculateConversionRate();
            const avgTime = calculateAverageTime();
            
            // Atualiza com dados reais
            document.getElementById('totalVisitors').textContent = visitors.length;
            document.getElementById('totalClicks').textContent = clicks.length;
            document.getElementById('conversionRate').textContent = conversionRate + '%';
            document.getElementById('avgTime').textContent = avgTime + 's';
            document.getElementById('activeVisitors').textContent = visitors.length + ' visitantes online';
            
            // Adiciona indicador visual de atualiza√ß√£o
            const indicators = document.querySelectorAll('.online-indicator');
            indicators.forEach(indicator => {
                indicator.style.animation = 'pulse 1s ease-in-out';
                setTimeout(() => {
                    indicator.style.animation = 'pulse 2s infinite';
                }, 1000);
            });
        }

        // Obt√©m visitantes √∫nicos
        function getUniqueVisitors() {
            const sessions = new Set();
            trackingData.forEach(entry => {
                sessions.add(entry.sessionId);
            });
            return Array.from(sessions);
        }

        // Obt√©m cliques em bot√µes
        function getButtonClicks() {
            return trackingData.filter(entry => entry.type === 'button_click');
        }

        // Calcula taxa de convers√£o
        function calculateConversionRate() {
            const visitors = getUniqueVisitors().length;
            const clicks = getButtonClicks().length;
            return visitors > 0 ? Math.round((clicks / visitors) * 100) : 0;
        }

        // Calcula tempo m√©dio
        function calculateAverageTime() {
            const timeEntries = trackingData.filter(entry => entry.type === 'time_tracking');
            if (timeEntries.length === 0) return 0;
            
            const totalTime = timeEntries.reduce((sum, entry) => sum + (entry.data.timeOnPage || 0), 0);
            return Math.round(totalTime / timeEntries.length);
        }

        // Atualiza lista de visitantes - VERS√ÉO TEMPO REAL
        function updateVisitorsList() {
            const visitorsList = document.getElementById('visitorsList');
            if (!visitorsList) return;
            
            const visitors = getUniqueVisitors();
            const limitedVisitors = visitors.slice(0, 10); // Limita a 10 visitantes
            
            if (limitedVisitors.length === 0) {
                visitorsList.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum visitante detectado</p>';
                return;
            }
            
            visitorsList.innerHTML = limitedVisitors.map(sessionId => {
                const visitorData = trackingData.filter(entry => entry.sessionId === sessionId);
                const device = visitorData.find(entry => entry.type === 'device_info');
                const clicks = visitorData.filter(entry => entry.type === 'button_click');
                const latestEntry = visitorData[visitorData.length - 1];
                
                return `
                    <div class="visitor-card rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center">
                                    <span class="text-white font-bold text-sm">V</span>
                                </div>
                                <div>
                                    <p class="font-semibold">Visitante ${sessionId.slice(-6)}</p>
                                    <p class="text-sm text-gray-400">${new Date(latestEntry?.timestamp).toLocaleString()}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="online-indicator"></div>
                                <span class="text-sm text-green-400">Online</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <p class="text-sm text-gray-400">Localiza√ß√£o</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="location-badge text-xs px-2 py-1 rounded">${device?.data?.city || 'N√£o identificada'}</span>
                                    <span class="text-sm">${device?.data?.state || 'N/A'}</span>
                                </div>
                            </div>
                            
                            <div>
                                <p class="text-sm text-gray-400">Dispositivo</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="device-badge text-xs px-2 py-1 rounded">${getDeviceType(device?.data?.userAgent)}</span>
                                </div>
                            </div>
                            
                            <div>
                                <p class="text-sm text-gray-400">A√ß√µes</p>
                                <div class="flex items-center gap-2 mt-1">
                                    ${clicks.length > 0 ? 
                                        `<span class="click-highlight text-xs px-2 py-1 rounded">${clicks.length} cliques</span>` : 
                                        '<span class="text-xs text-gray-500">Nenhuma a√ß√£o</span>'
                                    }
                                </div>
                            </div>
                        </div>
                        
                        ${clicks.length > 0 ? `
                            <div class="mt-3 pt-3 border-t border-gray-700">
                                <p class="text-sm text-gray-400 mb-2">Cliques registrados:</p>
                                <div class="space-y-1">
                                    ${clicks.map(click => `
                                        <div class="flex items-center justify-between text-sm">
                                            <span>${click.data.packageName}</span>
                                            <span class="text-green-400 font-semibold">${click.data.price}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Determina tipo de dispositivo
        function getDeviceType(userAgent) {
            if (!userAgent) return 'Desconhecido';
            const ua = userAgent.toLowerCase();
            if (/mobile|android|iphone/.test(ua)) return 'Mobile';
            if (/tablet|ipad/.test(ua)) return 'Tablet';
            return 'Desktop';
        }

        // Gr√°ficos removidos - apenas lista de estados

        // Lista de visitantes por estado - VERS√ÉO TEMPO REAL
        function updateLocationList() {
            const locationList = document.getElementById('locationList');
            if (!locationList) return;
            
            const locations = {};
            
            // Processa dados reais de localiza√ß√£o
            trackingData.forEach(entry => {
                if (entry.type === 'device_info' && entry.data.state) {
                    const state = entry.data.state;
                    locations[state] = (locations[state] || 0) + 1;
                }
            });

            // Ordena por n√∫mero de visitantes
            const sortedLocations = Object.entries(locations)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const totalVisitors = Object.values(locations).reduce((sum, count) => sum + count, 0);

            if (sortedLocations.length === 0) {
                locationList.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum dado de localiza√ß√£o dispon√≠vel</p>';
                return;
            }

            locationList.innerHTML = sortedLocations.map(([state, count]) => {
                const percentage = totalVisitors > 0 ? Math.round((count / totalVisitors) * 100) : 0;
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg hover:bg-gray-700/50 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold text-xs">${state.slice(0, 2)}</span>
                            </div>
                            <div>
                                <p class="font-semibold">${state}</p>
                                <p class="text-sm text-gray-400">${count} visitante${count !== 1 ? 's' : ''}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-red-400">${count}</p>
                            <p class="text-sm text-gray-400">${percentage}%</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Atualiza dados
        function refreshData() {
            console.log('üîÑ Atualizando dados manualmente...');
            
            loadTrackingData();
            updateStats();
            updateVisitorsList();
            updateLocationList();
            
            // Mostra notifica√ß√£o
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚úÖ Atualizado!';
            button.disabled = true;
            
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 2000);
        }

        // Atualiza timestamp da √∫ltima atualiza√ß√£o
        function updateTimestamp() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('updateTime').textContent = timeString;
        }

        // Mostra notifica√ß√£o de atualiza√ß√£o
        function showUpdateNotification() {
            const status = document.getElementById('systemStatus');
            const originalText = status.textContent;
            status.textContent = 'Dados Atualizados!';
            status.className = 'text-sm text-yellow-400';
            
            setTimeout(() => {
                status.textContent = originalText;
                status.className = 'text-sm text-green-400';
            }, 2000);
        }

        // Inicializa quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', function() {
            // Aguarda um pouco para garantir que tudo est√° carregado
            setTimeout(initDashboard, 100);
        });
    </script>
</body>
</html>
