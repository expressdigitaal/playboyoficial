<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Monitoramento - Playboy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #0b0b0b; color: white; }
        .card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        .stat-card { background: linear-gradient(135deg, #1a1a1a, #2a2a2a); }
        .online-indicator { 
            width: 8px; height: 8px; 
            background: #10b981; 
            border-radius: 50%; 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .visitor-card { 
            background: linear-gradient(135deg, #1e1e1e, #2d2d2d); 
            border-left: 4px solid #e50914; 
        }
        .click-highlight { background: rgba(229, 9, 20, 0.2); }
        .location-badge { background: #3b82f6; }
        .age-badge { background: #8b5cf6; }
        .device-badge { background: #10b981; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-black/70 backdrop-blur border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm">P</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Dashboard de Monitoramento</h1>
                        <p class="text-sm text-gray-400">Playboy - An√°lise de Visitantes</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <div class="online-indicator"></div>
                        <span class="text-sm text-green-400">Sistema Ativo</span>
                    </div>
                    <button onclick="refreshData()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md text-sm font-medium transition">
                        üîÑ Atualizar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Estat√≠sticas Principais -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total de Visitantes -->
            <div class="stat-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Total de Visitantes</p>
                        <p class="text-2xl font-bold text-white" id="totalVisitors">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">üë•</span>
                    </div>
                </div>
            </div>

            <!-- Cliques em Bot√µes -->
            <div class="stat-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Cliques em Bot√µes</p>
                        <p class="text-2xl font-bold text-white" id="totalClicks">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">üõí</span>
                    </div>
                </div>
            </div>

            <!-- Convers√£o -->
            <div class="stat-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Taxa de Convers√£o</p>
                        <p class="text-2xl font-bold text-white" id="conversionRate">0%</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">üìà</span>
                    </div>
                </div>
            </div>

            <!-- Tempo M√©dio -->
            <div class="stat-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Tempo M√©dio</p>
                        <p class="text-2xl font-bold text-white" id="avgTime">0s</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">‚è±Ô∏è</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Gr√°fico de Cliques por Pacote -->
            <div class="card rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Cliques por Pacote</h3>
                <canvas id="packageChart" width="400" height="200"></canvas>
            </div>

            <!-- Lista de Visitantes por Estado -->
            <div class="card rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Visitantes por Estado</h3>
                <div id="locationList" class="space-y-3">
                    <!-- Lista ser√° preenchida dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Lista de Visitantes em Tempo Real -->
        <div class="card rounded-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold">Visitantes Ativos</h3>
                <div class="flex items-center gap-2">
                    <div class="online-indicator"></div>
                    <span class="text-sm text-green-400" id="activeVisitors">0 visitantes online</span>
                </div>
            </div>
            
            <div class="space-y-4" id="visitorsList">
                <!-- Visitantes ser√£o inseridos aqui dinamicamente -->
            </div>
        </div>

        <!-- An√°lise Detalhada -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
            <!-- Dispositivos -->
            <div class="card rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Dispositivos</h3>
                <div id="deviceStats" class="space-y-3">
                    <!-- Estat√≠sticas de dispositivos -->
                </div>
            </div>

            <!-- Faixa Et√°ria Estimada -->
            <div class="card rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Faixa Et√°ria</h3>
                <div id="ageStats" class="space-y-3">
                    <!-- Estat√≠sticas de idade -->
                </div>
            </div>

            <!-- Localiza√ß√£o -->
            <div class="card rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Localiza√ß√£o</h3>
                <div id="locationStats" class="space-y-3">
                    <!-- Estat√≠sticas de localiza√ß√£o -->
                </div>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script src="tracking-system.js"></script>
    <script>
        let packageChart, locationChart;
        let trackingData = [];
        let dashboardInitialized = false;

        // Inicializa o dashboard
        function initDashboard() {
            if (dashboardInitialized) {
                console.log('‚ö†Ô∏è Dashboard j√° foi inicializado');
                return;
            }
            
            dashboardInitialized = true;
            console.log('üöÄ Inicializando dashboard...');
            
            loadTrackingData();
            createCharts();
            updateStats();
            updateVisitorsList();
            
            // Atualiza a cada 30 segundos (aumentado para evitar sobrecarga)
            setInterval(() => {
                loadTrackingData();
                updateStats();
                updateVisitorsList();
                updateLocationList();
                
                // S√≥ atualiza gr√°ficos ocasionalmente
                if (Math.random() < 0.1) { // 10% de chance de atualizar gr√°ficos
                    createPackageChart();
                }
            }, 30000);
        }

        // Carrega dados do sistema de tracking
        function loadTrackingData() {
            // Tenta carregar dados do site Playboy
            if (typeof getPlayboyTrackingData === 'function') {
                trackingData = getPlayboyTrackingData();
                console.log('üìä Dados carregados do site Playboy:', trackingData.length, 'entradas');
            } else if (typeof getTrackingData === 'function') {
                trackingData = getTrackingData();
                console.log('üìä Dados carregados do sistema local:', trackingData.length, 'entradas');
            } else {
                // Dados de exemplo para demonstra√ß√£o
                trackingData = getSampleData();
                console.log('üìä Usando dados de exemplo:', trackingData.length, 'entradas');
            }
        }

        // Dados de exemplo para demonstra√ß√£o
        function getSampleData() {
            return [
                {
                    sessionId: 'visitor_1703123456789_abc123',
                    timestamp: new Date(Date.now() - 300000).toISOString(),
                    type: 'geolocation',
                    data: {
                        city: 'S√£o Paulo',
                        state: 'SP',
                        country: 'Brasil'
                    }
                },
                {
                    sessionId: 'visitor_1703123456789_abc123',
                    timestamp: new Date(Date.now() - 200000).toISOString(),
                    type: 'button_click',
                    data: {
                        packageName: 'Pacote Premium',
                        price: 'R$ 19,90'
                    }
                },
                {
                    sessionId: 'visitor_1703123456789_def456',
                    timestamp: new Date(Date.now() - 150000).toISOString(),
                    type: 'geolocation',
                    data: {
                        city: 'Rio de Janeiro',
                        state: 'RJ',
                        country: 'Brasil'
                    }
                },
                {
                    sessionId: 'visitor_1703123456789_def456',
                    timestamp: new Date(Date.now() - 100000).toISOString(),
                    type: 'button_click',
                    data: {
                        packageName: 'Pacote Sedu√ß√£o',
                        price: 'R$ 10,00'
                    }
                }
            ];
        }

        // Atualiza estat√≠sticas
        function updateStats() {
            const visitors = getUniqueVisitors();
            const clicks = getButtonClicks();
            const conversionRate = calculateConversionRate();
            const avgTime = calculateAverageTime();

            document.getElementById('totalVisitors').textContent = visitors.length;
            document.getElementById('totalClicks').textContent = clicks.length;
            document.getElementById('conversionRate').textContent = conversionRate + '%';
            document.getElementById('avgTime').textContent = avgTime + 's';
            document.getElementById('activeVisitors').textContent = visitors.length + ' visitantes online';
        }

        // Obt√©m visitantes √∫nicos
        function getUniqueVisitors() {
            const sessions = new Set();
            trackingData.forEach(entry => {
                sessions.add(entry.sessionId);
            });
            return Array.from(sessions);
        }

        // Obt√©m cliques em bot√µes
        function getButtonClicks() {
            return trackingData.filter(entry => entry.type === 'button_click');
        }

        // Calcula taxa de convers√£o
        function calculateConversionRate() {
            const visitors = getUniqueVisitors().length;
            const clicks = getButtonClicks().length;
            return visitors > 0 ? Math.round((clicks / visitors) * 100) : 0;
        }

        // Calcula tempo m√©dio
        function calculateAverageTime() {
            const timeEntries = trackingData.filter(entry => entry.type === 'time_tracking');
            if (timeEntries.length === 0) return 0;
            
            const totalTime = timeEntries.reduce((sum, entry) => sum + (entry.data.timeOnPage || 0), 0);
            return Math.round(totalTime / timeEntries.length);
        }

        // Atualiza lista de visitantes
        function updateVisitorsList() {
            const visitorsList = document.getElementById('visitorsList');
            const visitors = getUniqueVisitors();
            
            // Limita a 20 visitantes para evitar sobrecarga
            const limitedVisitors = visitors.slice(0, 20);
            
            visitorsList.innerHTML = limitedVisitors.map(sessionId => {
                const visitorData = trackingData.filter(entry => entry.sessionId === sessionId);
                const location = visitorData.find(entry => entry.type === 'geolocation' || entry.type === 'ip_location');
                const clicks = visitorData.filter(entry => entry.type === 'button_click');
                const device = visitorData.find(entry => entry.type === 'device_info');
                
                return `
                    <div class="visitor-card rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center">
                                    <span class="text-white font-bold text-sm">V</span>
                                </div>
                                <div>
                                    <p class="font-semibold">Visitante ${sessionId.slice(-6)}</p>
                                    <p class="text-sm text-gray-400">${new Date(visitorData[0]?.timestamp).toLocaleString()}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="online-indicator"></div>
                                <span class="text-sm text-green-400">Online</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <p class="text-sm text-gray-400">Localiza√ß√£o</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="location-badge text-xs px-2 py-1 rounded">${location?.data?.city || 'N√£o identificada'}</span>
                                    <span class="text-sm">${location?.data?.state || 'N/A'}</span>
                                </div>
                            </div>
                            
                            <div>
                                <p class="text-sm text-gray-400">Dispositivo</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="device-badge text-xs px-2 py-1 rounded">${getDeviceType(device?.data?.userAgent)}</span>
                                </div>
                            </div>
                            
                            <div>
                                <p class="text-sm text-gray-400">A√ß√µes</p>
                                <div class="flex items-center gap-2 mt-1">
                                    ${clicks.length > 0 ? 
                                        `<span class="click-highlight text-xs px-2 py-1 rounded">${clicks.length} cliques</span>` : 
                                        '<span class="text-xs text-gray-500">Nenhuma a√ß√£o</span>'
                                    }
                                </div>
                            </div>
                        </div>
                        
                        ${clicks.length > 0 ? `
                            <div class="mt-3 pt-3 border-t border-gray-700">
                                <p class="text-sm text-gray-400 mb-2">Cliques registrados:</p>
                                <div class="space-y-1">
                                    ${clicks.map(click => `
                                        <div class="flex items-center justify-between text-sm">
                                            <span>${click.data.packageName}</span>
                                            <span class="text-green-400 font-semibold">${click.data.price}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Determina tipo de dispositivo
        function getDeviceType(userAgent) {
            if (!userAgent) return 'Desconhecido';
            const ua = userAgent.toLowerCase();
            if (/mobile|android|iphone/.test(ua)) return 'Mobile';
            if (/tablet|ipad/.test(ua)) return 'Tablet';
            return 'Desktop';
        }

        // Cria gr√°ficos
        function createCharts() {
            try {
                createPackageChart();
                updateLocationList();
            } catch (error) {
                console.error('Erro ao criar gr√°ficos:', error);
                // Se der erro, tenta novamente ap√≥s 1 segundo
                setTimeout(() => {
                    try {
                        createPackageChart();
                        updateLocationList();
                    } catch (e) {
                        console.error('Erro persistente nos gr√°ficos:', e);
                    }
                }, 1000);
            }
        }

        // Gr√°fico de cliques por pacote
        function createPackageChart() {
            const ctx = document.getElementById('packageChart').getContext('2d');
            const clicks = getButtonClicks();
            const packageStats = {};
            
            clicks.forEach(click => {
                const packageName = click.data.packageName;
                packageStats[packageName] = (packageStats[packageName] || 0) + 1;
            });

            // S√≥ recria se n√£o existir ou se houver dados novos
            if (packageChart && Object.keys(packageStats).length === 0) {
                return;
            }

            if (packageChart) packageChart.destroy();
            
            packageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(packageStats),
                    datasets: [{
                        data: Object.values(packageStats),
                        backgroundColor: ['#e50914', '#ff6b6b', '#4ecdc4', '#45b7d1'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    }
                }
            });
        }

        // Lista de visitantes por estado
        function updateLocationList() {
            const locationList = document.getElementById('locationList');
            const locations = {};
            
            trackingData.forEach(entry => {
                if (entry.type === 'geolocation' || entry.type === 'ip_location') {
                    const state = entry.data.state || 'N√£o identificado';
                    locations[state] = (locations[state] || 0) + 1;
                }
            });

            // Ordena por n√∫mero de visitantes
            const sortedLocations = Object.entries(locations)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            const totalVisitors = Object.values(locations).reduce((sum, count) => sum + count, 0);

            if (sortedLocations.length === 0) {
                if (locationList.innerHTML !== '<p class="text-gray-400 text-center py-4">Nenhum dado de localiza√ß√£o dispon√≠vel</p>') {
                    locationList.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum dado de localiza√ß√£o dispon√≠vel</p>';
                }
                return;
            }

            locationList.innerHTML = sortedLocations.map(([state, count]) => {
                const percentage = totalVisitors > 0 ? Math.round((count / totalVisitors) * 100) : 0;
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg hover:bg-gray-700/50 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold text-xs">${state.slice(0, 2)}</span>
                            </div>
                            <div>
                                <p class="font-semibold">${state}</p>
                                <p class="text-sm text-gray-400">${count} visitante${count !== 1 ? 's' : ''}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-red-400">${count}</p>
                            <p class="text-sm text-gray-400">${percentage}%</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Atualiza dados
        function refreshData() {
            loadTrackingData();
            updateStats();
            updateVisitorsList();
            updateLocationList();
            
            // S√≥ recria gr√°ficos se necess√°rio
            if (trackingData.length > 0) {
                createPackageChart();
            }
            
            // Mostra notifica√ß√£o
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚úÖ Atualizado!';
            button.disabled = true;
            
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 2000);
        }

        // Inicializa quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
