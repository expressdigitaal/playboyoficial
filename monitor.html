<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Monitoramento - Playboy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #0b0b0b; color: white; }
        .card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        .stat-card { background: linear-gradient(135deg, #1a1a1a, #2a2a2a); }
        .online-indicator { 
            width: 8px; height: 8px; 
            background: #10b981; 
            border-radius: 50%; 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .visitor-card { 
            background: linear-gradient(135deg, #1e1e1e, #2d2d2d); 
            border-left: 4px solid #e50914; 
        }
        .click-highlight { background: rgba(229, 9, 20, 0.2); }
        .location-badge { background: #3b82f6; }
        .age-badge { background: #8b5cf6; }
        .device-badge { background: #10b981; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-black/70 backdrop-blur border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm">P</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Dashboard de Monitoramento</h1>
                        <p class="text-sm text-gray-400">Playboy - An√°lise de Visitantes</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <div class="online-indicator"></div>
                        <span class="text-sm text-green-400" id="systemStatus">Sistema Ativo</span>
                    </div>
                    <div class="text-xs text-gray-400" id="lastUpdate">
                        √öltima atualiza√ß√£o: <span id="updateTime">--:--</span>
                    </div>
                    <button onclick="forceTestData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-sm font-medium transition">
                        üß™ Teste
                    </button>
                    <button onclick="refreshData()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md text-sm font-medium transition">
                        üîÑ Atualizar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Estat√≠sticas Principais -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total de Visitantes -->
            <div class="stat-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Total de Visitantes</p>
                        <p class="text-2xl font-bold text-white" id="totalVisitors">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">üë•</span>
                    </div>
                </div>
            </div>

            <!-- Cliques em Bot√µes -->
            <div class="stat-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Cliques em Bot√µes</p>
                        <p class="text-2xl font-bold text-white" id="totalClicks">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">üõí</span>
                    </div>
                </div>
            </div>

            <!-- Convers√£o -->
            <div class="stat-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Taxa de Convers√£o</p>
                        <p class="text-2xl font-bold text-white" id="conversionRate">0%</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">üìà</span>
                    </div>
                </div>
            </div>

            <!-- Tempo M√©dio -->
            <div class="stat-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">Tempo M√©dio</p>
                        <p class="text-2xl font-bold text-white" id="avgTime">0s</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">‚è±Ô∏è</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o 1: Pessoas que Clicaram nos Bot√µes -->
        <div class="card rounded-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    üõí Pessoas que Clicaram nos Bot√µes
                </h3>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-sm text-green-400" id="clickersCount">0 pessoas</span>
                </div>
            </div>
            
            <div class="space-y-4" id="clickersList">
                <!-- Pessoas que clicaram ser√£o inseridas aqui -->
            </div>
        </div>

        <!-- Se√ß√£o 2: An√°lise de Dispositivos e Pacotes -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Dispositivos -->
            <div class="card rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    üì± Dispositivos (Quantidade de Cliques)
                </h3>
                <div id="deviceStats" class="space-y-3">
                    <!-- Estat√≠sticas de dispositivos -->
                </div>
            </div>

            <!-- Pacotes Clicados -->
            <div class="card rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    üì¶ Pacotes Clicados
                </h3>
                <div id="packageStats" class="space-y-3">
                    <!-- Estat√≠sticas de pacotes -->
                </div>
            </div>
        </div>

        <!-- Se√ß√£o 3: Pessoas Apenas Visitando (Sem A√ß√µes) -->
        <div class="card rounded-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    üëÄ Pessoas Apenas Visitando (Sem Fazer Nada)
                </h3>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                    <span class="text-sm text-blue-400" id="viewersCount">0 pessoas</span>
                </div>
            </div>
            
            <div class="space-y-4" id="viewersList">
                <!-- Pessoas apenas visitando ser√£o inseridas aqui -->
            </div>
        </div>

        <!-- Se√ß√£o 4: Visitantes por Estado -->
        <div class="max-w-4xl mx-auto mb-8">
            <div class="card rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    üó∫Ô∏è Visitantes por Estado
                </h3>
                <div id="locationList" class="space-y-3">
                    <!-- Lista ser√° preenchida dinamicamente -->
                </div>
            </div>
        </div>

    </section>

    <!-- Scripts -->
    <script>
        let trackingData = [];
        let dashboardInitialized = false;

        // Inicializa o dashboard - VERS√ÉO TEMPO REAL
        function initDashboard() {
            console.log('üöÄ Inicializando dashboard em tempo real...');
            
            // Carrega dados iniciais
            loadTrackingData();
            console.log('üìä Dados carregados:', trackingData.length, 'entradas');
            console.log('üìä Tipos de dados:', [...new Set(trackingData.map(d => d.type))]);
            
            updateStats();
            updateClickersList();
            updateViewersList();
            updateDeviceStats();
            updatePackageStats();
            updateLocationList();
            
            // Atualiza√ß√£o em tempo real a cada 10 segundos (mais est√°vel)
            setInterval(() => {
                const hasChanges = loadTrackingData();
                updateStats();
                updateClickersList();
                updateViewersList();
                updateDeviceStats();
                updatePackageStats();
                updateLocationList();
                updateTimestamp();
                
                if (hasChanges) {
                    console.log('üîÑ Dashboard atualizado com novos dados!');
                    showUpdateNotification();
                } else {
                    console.log('üîÑ Dashboard atualizado em tempo real');
                }
            }, 10000);
        }

        // Carrega dados do sistema de tracking - VERS√ÉO TEMPO REAL
        function loadTrackingData() {
            let newData = [];
            
            // Tenta carregar dados do site Playboy
            if (typeof getPlayboyTrackingData === 'function') {
                newData = getPlayboyTrackingData();
                console.log('üìä Dados carregados do site Playboy:', newData.length, 'entradas');
            } else if (typeof getTrackingData === 'function') {
                newData = getTrackingData();
                console.log('üìä Dados carregados do sistema local:', newData.length, 'entradas');
            } else {
                // Dados de exemplo para demonstra√ß√£o
                newData = getSampleData();
                console.log('üìä Usando dados de exemplo:', newData.length, 'entradas');
            }
            
            // Detecta mudan√ßas nos dados
            if (newData.length !== trackingData.length) {
                console.log('üîÑ Novos dados detectados!', newData.length - trackingData.length, 'novas entradas');
                trackingData = newData;
                return true; // Indica que houve mudan√ßas
            }
            
            // Verifica se h√° dados novos por timestamp
            const latestTimestamp = Math.max(...newData.map(entry => new Date(entry.timestamp).getTime()));
            const currentLatestTimestamp = Math.max(...trackingData.map(entry => new Date(entry.timestamp).getTime()));
            
            if (latestTimestamp > currentLatestTimestamp) {
                console.log('üîÑ Dados atualizados detectados!');
                trackingData = newData;
                return true; // Indica que houve mudan√ßas
            }
            
            return false; // Nenhuma mudan√ßa detectada
        }

        // Dados de exemplo para demonstra√ß√£o - VERS√ÉO TEMPO REAL
        function getSampleData() {
            const now = Date.now();
            const cities = ['S√£o Paulo', 'Rio de Janeiro', 'Belo Horizonte', 'Salvador', 'Bras√≠lia', 'Fortaleza', 'Manaus', 'Curitiba'];
            const states = ['SP', 'RJ', 'MG', 'BA', 'DF', 'CE', 'AM', 'PR'];
            const packages = [
                { name: 'Pacote Premium', price: 'R$ 19,90' },
                { name: 'Pacote Sedu√ß√£o', price: 'R$ 10,00' }
            ];
            
            const data = [];
            
            // Gera dados simulados com timestamps recentes
            for (let i = 0; i < 5 + Math.floor(Math.random() * 10); i++) {
                const sessionId = 'playboy_' + (now - Math.random() * 3600000) + '_' + Math.random().toString(36).substr(2, 6);
                const cityIndex = Math.floor(Math.random() * cities.length);
                const packageIndex = Math.floor(Math.random() * packages.length);
                const timeOffset = Math.random() * 300000; // √öltimos 5 minutos
                
                // Dados de dispositivo
                data.push({
                    sessionId: sessionId,
                    timestamp: new Date(now - timeOffset).toISOString(),
                    type: 'device_info',
                    data: {
                        userAgent: Math.random() > 0.5 ? 'Mobile' : 'Desktop',
                        city: cities[cityIndex],
                        state: states[cityIndex]
                    }
                });
                
                // Dados de clique (70% de chance)
                if (Math.random() > 0.3) {
                    data.push({
                        sessionId: sessionId,
                        timestamp: new Date(now - timeOffset + 10000).toISOString(),
                        type: 'button_click',
                        data: {
                            packageName: packages[packageIndex].name,
                            price: packages[packageIndex].price
                        }
                    });
                }
            }
            
            console.log('üìä Dados de exemplo gerados:', data.length, 'entradas');
            console.log('üìä Tipos gerados:', [...new Set(data.map(d => d.type))]);
            
            return data;
        }

        // Fun√ß√£o de teste para for√ßar dados
        function forceTestData() {
            console.log('üß™ For√ßando dados de teste...');
            trackingData = [
                {
                    sessionId: 'test_001',
                    timestamp: new Date().toISOString(),
                    type: 'device_info',
                    data: {
                        userAgent: 'Desktop',
                        city: 'S√£o Paulo',
                        state: 'SP'
                    }
                },
                {
                    sessionId: 'test_001',
                    timestamp: new Date().toISOString(),
                    type: 'button_click',
                    data: {
                        packageName: 'Pacote Premium',
                        price: 'R$ 19,90'
                    }
                },
                {
                    sessionId: 'test_002',
                    timestamp: new Date().toISOString(),
                    type: 'device_info',
                    data: {
                        userAgent: 'Mobile',
                        city: 'Rio de Janeiro',
                        state: 'RJ'
                    }
                }
            ];
            
            updateStats();
            updateClickersList();
            updateViewersList();
            updateDeviceStats();
            updatePackageStats();
            updateLocationList();
        }

        // Atualiza estat√≠sticas - VERS√ÉO TEMPO REAL
        function updateStats() {
            const visitors = getUniqueVisitors();
            const clicks = getButtonClicks();
            const conversionRate = calculateConversionRate();
            const avgTime = calculateAverageTime();
            
            // Atualiza com dados reais
            document.getElementById('totalVisitors').textContent = visitors.length;
            document.getElementById('totalClicks').textContent = clicks.length;
            document.getElementById('conversionRate').textContent = conversionRate + '%';
            document.getElementById('avgTime').textContent = avgTime + 's';
            document.getElementById('activeVisitors').textContent = visitors.length + ' visitantes online';
            
            // Adiciona indicador visual de atualiza√ß√£o
            const indicators = document.querySelectorAll('.online-indicator');
            indicators.forEach(indicator => {
                indicator.style.animation = 'pulse 1s ease-in-out';
                setTimeout(() => {
                    indicator.style.animation = 'pulse 2s infinite';
                }, 1000);
            });
        }

        // Obt√©m visitantes √∫nicos
        function getUniqueVisitors() {
            const sessions = new Set();
            trackingData.forEach(entry => {
                sessions.add(entry.sessionId);
            });
            return Array.from(sessions);
        }

        // Obt√©m cliques em bot√µes
        function getButtonClicks() {
            return trackingData.filter(entry => entry.type === 'button_click');
        }

        // Calcula taxa de convers√£o
        function calculateConversionRate() {
            const visitors = getUniqueVisitors().length;
            const clicks = getButtonClicks().length;
            return visitors > 0 ? Math.round((clicks / visitors) * 100) : 0;
        }

        // Calcula tempo m√©dio
        function calculateAverageTime() {
            const timeEntries = trackingData.filter(entry => entry.type === 'time_tracking');
            if (timeEntries.length === 0) return 0;
            
            const totalTime = timeEntries.reduce((sum, entry) => sum + (entry.data.timeOnPage || 0), 0);
            return Math.round(totalTime / timeEntries.length);
        }

        // Atualiza lista de pessoas que clicaram nos bot√µes
        function updateClickersList() {
            const clickersList = document.getElementById('clickersList');
            const clickersCount = document.getElementById('clickersCount');
            if (!clickersList) {
                console.log('‚ùå Elemento clickersList n√£o encontrado');
                return;
            }
            
            console.log('üîÑ Atualizando lista de cliques...');
            console.log('üìä Dados dispon√≠veis:', trackingData.length);
            
            const visitors = getUniqueVisitors();
            console.log('üë• Visitantes √∫nicos:', visitors.length);
            
            const clickers = visitors.filter(sessionId => {
                const visitorData = trackingData.filter(entry => entry.sessionId === sessionId);
                const hasClicks = visitorData.some(entry => entry.type === 'button_click');
                console.log(`üîç Visitante ${sessionId}: ${hasClicks ? 'TEM cliques' : 'SEM cliques'}`);
                return hasClicks;
            });
            
            console.log('üõí Pessoas que clicaram:', clickers.length);
            
            if (clickersCount) {
                clickersCount.textContent = `${clickers.length} pessoas`;
            }
            
            if (clickers.length === 0) {
                clickersList.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhuma pessoa clicou nos bot√µes ainda</p>';
                return;
            }
            
            clickersList.innerHTML = clickers.slice(0, 8).map(sessionId => {
                const visitorData = trackingData.filter(entry => entry.sessionId === sessionId);
                const device = visitorData.find(entry => entry.type === 'device_info');
                const clicks = visitorData.filter(entry => entry.type === 'button_click');
                const latestEntry = visitorData[visitorData.length - 1];
                
                return `
                    <div class="visitor-card rounded-lg p-4 border-l-4 border-green-500">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center">
                                    <span class="text-white font-bold text-sm">C</span>
                                </div>
                                <div>
                                    <p class="font-semibold">Visitante ${sessionId.slice(-6)}</p>
                                    <p class="text-sm text-gray-400">${new Date(latestEntry?.timestamp).toLocaleString()}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                <span class="text-sm text-green-400">${clicks.length} cliques</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <p class="text-sm text-gray-400">Dispositivo</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="device-badge text-xs px-2 py-1 rounded">${getDeviceType(device?.data?.userAgent)}</span>
                                </div>
                            </div>
                            
                            <div>
                                <p class="text-sm text-gray-400">Localiza√ß√£o</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="location-badge text-xs px-2 py-1 rounded">${device?.data?.city || 'N√£o identificada'}</span>
                                </div>
                            </div>
                            
                            <div>
                                <p class="text-sm text-gray-400">√öltimo Clique</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs text-green-400">${clicks[clicks.length - 1]?.data?.packageName || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 pt-3 border-t border-gray-700">
                            <p class="text-sm text-gray-400 mb-2">Todos os cliques:</p>
                            <div class="space-y-1">
                                ${clicks.map(click => `
                                    <div class="flex items-center justify-between text-sm">
                                        <span>${click.data.packageName}</span>
                                        <span class="text-green-400 font-semibold">${click.data.price}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Atualiza lista de pessoas apenas visitando (sem a√ß√µes)
        function updateViewersList() {
            const viewersList = document.getElementById('viewersList');
            const viewersCount = document.getElementById('viewersCount');
            if (!viewersList) {
                console.log('‚ùå Elemento viewersList n√£o encontrado');
                return;
            }
            
            console.log('üîÑ Atualizando lista de visualizadores...');
            
            const visitors = getUniqueVisitors();
            const viewers = visitors.filter(sessionId => {
                const visitorData = trackingData.filter(entry => entry.sessionId === sessionId);
                return !visitorData.some(entry => entry.type === 'button_click');
            });
            
            viewersCount.textContent = `${viewers.length} pessoas`;
            
            if (viewers.length === 0) {
                viewersList.innerHTML = '<p class="text-gray-400 text-center py-4">Todas as pessoas est√£o interagindo com o site</p>';
                return;
            }
            
            viewersList.innerHTML = viewers.slice(0, 6).map(sessionId => {
                const visitorData = trackingData.filter(entry => entry.sessionId === sessionId);
                const device = visitorData.find(entry => entry.type === 'device_info');
                const latestEntry = visitorData[visitorData.length - 1];
                
                return `
                    <div class="visitor-card rounded-lg p-4 border-l-4 border-blue-500">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
                                    <span class="text-white font-bold text-sm">V</span>
                                </div>
                                <div>
                                    <p class="font-semibold">Visitante ${sessionId.slice(-6)}</p>
                                    <p class="text-sm text-gray-400">${new Date(latestEntry?.timestamp).toLocaleString()}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                                <span class="text-sm text-blue-400">Apenas visualizando</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-400">Dispositivo</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="device-badge text-xs px-2 py-1 rounded">${getDeviceType(device?.data?.userAgent)}</span>
                                </div>
                            </div>
                            
                            <div>
                                <p class="text-sm text-gray-400">Localiza√ß√£o</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="location-badge text-xs px-2 py-1 rounded">${device?.data?.city || 'N√£o identificada'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Atualiza estat√≠sticas de dispositivos
        function updateDeviceStats() {
            const deviceStats = document.getElementById('deviceStats');
            if (!deviceStats) {
                console.log('‚ùå Elemento deviceStats n√£o encontrado');
                return;
            }
            
            console.log('üîÑ Atualizando estat√≠sticas de dispositivos...');
            
            const deviceClicks = {};
            const deviceTypes = {};
            
            trackingData.forEach(entry => {
                if (entry.type === 'device_info') {
                    const deviceType = getDeviceType(entry.data.userAgent);
                    deviceTypes[deviceType] = (deviceTypes[deviceType] || 0) + 1;
                }
                if (entry.type === 'button_click') {
                    const sessionId = entry.sessionId;
                    const deviceEntry = trackingData.find(d => d.sessionId === sessionId && d.type === 'device_info');
                    if (deviceEntry) {
                        const deviceType = getDeviceType(deviceEntry.data.userAgent);
                        deviceClicks[deviceType] = (deviceClicks[deviceType] || 0) + 1;
                    }
                }
            });
            
            const sortedDevices = Object.entries(deviceTypes)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            deviceStats.innerHTML = sortedDevices.map(([device, count]) => {
                const clicks = deviceClicks[device] || 0;
                const clickRate = count > 0 ? Math.round((clicks / count) * 100) : 0;
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold text-xs">${device.slice(0, 1)}</span>
                            </div>
                            <div>
                                <p class="font-semibold">${device}</p>
                                <p class="text-sm text-gray-400">${count} visitantes</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-blue-400">${clicks}</p>
                            <p class="text-sm text-gray-400">${clickRate}% clicaram</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Atualiza estat√≠sticas de pacotes
        function updatePackageStats() {
            const packageStats = document.getElementById('packageStats');
            if (!packageStats) {
                console.log('‚ùå Elemento packageStats n√£o encontrado');
                return;
            }
            
            console.log('üîÑ Atualizando estat√≠sticas de pacotes...');
            
            const packageClicks = {};
            
            trackingData.forEach(entry => {
                if (entry.type === 'button_click') {
                    const packageName = entry.data.packageName;
                    packageClicks[packageName] = (packageClicks[packageName] || 0) + 1;
                }
            });
            
            const sortedPackages = Object.entries(packageClicks)
                .sort(([,a], [,b]) => b - a);
            
            if (sortedPackages.length === 0) {
                packageStats.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum pacote foi clicado ainda</p>';
                return;
            }
            
            packageStats.innerHTML = sortedPackages.map(([packageName, clicks]) => {
                const isPremium = packageName.includes('Premium');
                const color = isPremium ? 'red' : 'green';
                const icon = isPremium ? 'üëë' : 'üíé';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-${color}-600 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm">${icon}</span>
                            </div>
                            <div>
                                <p class="font-semibold">${packageName}</p>
                                <p class="text-sm text-gray-400">${clicks} cliques</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-${color}-400">${clicks}</p>
                            <p class="text-sm text-gray-400">cliques</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Determina tipo de dispositivo
        function getDeviceType(userAgent) {
            if (!userAgent) return 'Desconhecido';
            const ua = userAgent.toLowerCase();
            if (/mobile|android|iphone/.test(ua)) return 'Mobile';
            if (/tablet|ipad/.test(ua)) return 'Tablet';
            return 'Desktop';
        }

        // Gr√°ficos removidos - apenas lista de estados

        // Lista de visitantes por estado - VERS√ÉO TEMPO REAL
        function updateLocationList() {
            const locationList = document.getElementById('locationList');
            if (!locationList) {
                console.log('‚ùå Elemento locationList n√£o encontrado');
                return;
            }
            
            console.log('üîÑ Atualizando lista de estados...');
            
            const locations = {};
            
            // Processa dados reais de localiza√ß√£o
            trackingData.forEach(entry => {
                if (entry.type === 'device_info' && entry.data.state) {
                    const state = entry.data.state;
                    locations[state] = (locations[state] || 0) + 1;
                }
            });

            // Ordena por n√∫mero de visitantes
            const sortedLocations = Object.entries(locations)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const totalVisitors = Object.values(locations).reduce((sum, count) => sum + count, 0);

            if (sortedLocations.length === 0) {
                locationList.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum dado de localiza√ß√£o dispon√≠vel</p>';
                return;
            }

            locationList.innerHTML = sortedLocations.map(([state, count]) => {
                const percentage = totalVisitors > 0 ? Math.round((count / totalVisitors) * 100) : 0;
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg hover:bg-gray-700/50 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold text-xs">${state.slice(0, 2)}</span>
                            </div>
                            <div>
                                <p class="font-semibold">${state}</p>
                                <p class="text-sm text-gray-400">${count} visitante${count !== 1 ? 's' : ''}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-red-400">${count}</p>
                            <p class="text-sm text-gray-400">${percentage}%</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Atualiza dados
        function refreshData() {
            console.log('üîÑ Atualizando dados manualmente...');
            
            loadTrackingData();
            updateStats();
            updateClickersList();
            updateViewersList();
            updateDeviceStats();
            updatePackageStats();
            updateLocationList();
            
            // Mostra notifica√ß√£o
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚úÖ Atualizado!';
            button.disabled = true;
            
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 2000);
        }

        // Atualiza timestamp da √∫ltima atualiza√ß√£o
        function updateTimestamp() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('updateTime').textContent = timeString;
        }

        // Mostra notifica√ß√£o de atualiza√ß√£o
        function showUpdateNotification() {
            const status = document.getElementById('systemStatus');
            const originalText = status.textContent;
            status.textContent = 'Dados Atualizados!';
            status.className = 'text-sm text-yellow-400';
            
            setTimeout(() => {
                status.textContent = originalText;
                status.className = 'text-sm text-green-400';
            }, 2000);
        }

        // Inicializa quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', function() {
            // Aguarda um pouco para garantir que tudo est√° carregado
            setTimeout(initDashboard, 100);
        });
    </script>
</body>
</html>
